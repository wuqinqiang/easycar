syntax = "proto3";

package proto;

option go_package = "github.com/wuqinqiang/easycar/proto";

import "google/protobuf/empty.proto";
import "google/api/annotations.proto";


service EasyCar {
  rpc Begin(google.protobuf.Empty)returns(BeginResp){
    option (google.api.http) = {
      post:"/v1/begin",
      body:"*"
    };
  }
  rpc Register(RegisterReq)returns(RegisterResp){
    option (google.api.http) = {
      post:"/v1/register",
      body:"*"
    };
  }
  rpc Start(StartReq)returns(StartResp){}
  rpc Abort(AbortReq) returns(AbortResp){}
  rpc GetState(GetStateReq) returns(GetStateResp){}
}


enum Err {
  CODE_SUCCESS = 0;
  CODE_FAILED = 1;
}

enum TranType {
  UNKnow = 0;
  TCC = 1;
  SAGE = 2;
}
enum Action {
  UnKnowTransactionType = 0;
  Try = 1;
  Confirm = 2;
  Cancel = 3;
  Normal = 4;
  Compensation = 5;
}

enum BranchState {
  UnknowState = 0;
  Ready = 1;
  Retrying = 2;
  Success = 3;
  FailState = 4;
}



message RegisterReq {
  message Branch {
    string branchId = 1;
    string uri = 2;
    string reqData = 3;
    TranType tranType = 4;
    // todo remove pid?
    string pid = 5;
    string protocol = 6;
    Action action = 7;
    BranchState state = 8;
    // todo remove pid?
    int32 level = 9;
  }
  string gId = 1;
  repeated Branch branches = 2;
}
message RegisterResp {
}


enum GlobalState {
  GLOBAL_DEFAULT = 0;
  Begin = 1;
  Phase1Processing = 2;
  Phase1Retrying = 3;
  Phase1Failed = 4;
  Phase1Success = 5;
  Phase2Processing = 6;
  Phase2Retrying = 7;
  Phase2Failed = 8;
  Phase2Success = 9;
}



message BeginReq {
  TranType tranType = 1;
}

message BeginResp {
  string gId = 1;
}

message StartReq {
  string gId = 1;
}
message StartResp {
  GlobalState state = 1;
}


message AbortReq {
  string gId = 1;
}

message AbortResp {
}

message GetStateReq {
  string gId = 1;
}

message GetStateResp {
  GlobalState state = 1;
  // todo add branches state?
}